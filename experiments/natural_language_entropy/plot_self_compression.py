#!/usr/bin/env python3
"""Plot self-compression experiment results.

Produces plots and tables matching the style of plot_data_sources.py:
  1. Grouped bar chart: BPC per base model, grouped by generator
  2. Self vs Other summary bar chart
  3. Heatmap: compressor × generated file
  4. Model summary table
  5. Self-affinity table

Usage:
    .venv/bin/python3 plot_self_compression.py
"""

import json
import os
import sys

import matplotlib.pyplot as plt
import matplotlib.ticker as ticker
import numpy as np

RESULTS_FILE = "data/self_compression_results.json"
OUTPUT_DIR = "results/natural_language_entropy"

# Colour palette matching plot_data_sources.py
MODEL_COLORS = {
    "Qwen 2.5-3B":   "#6366f1",
    "LiquidAI 1.2B": "#f59e0b",
    "Gemma 3-1B":    "#10b981",
    "Gemma 3-4B":    "#06b6d4",
    "Qwen 3-1.7B":   "#ef4444",
    "Llama 3.2-1B":  "#ec4899",
    "Llama 3.2-3B":  "#8b5cf6",
}

# Which base model is "self" for each generator slug
SELF_MAP = {
    "llama32_3b": "Llama 3.2-3B",
    "gemma3_4b":  "Gemma 3-4B",
    "qwen25_3b":  "Qwen 2.5-3B",
}

GENERATOR_LABELS = {
    "llama32_3b": "Llama 3.2-3B-Instruct",
    "gemma3_4b":  "Gemma 3-4B-IT",
    "qwen25_3b":  "Qwen 2.5-3B-Instruct",
}

GENERATOR_COLORS = {
    "llama32_3b": "#8b5cf6",
    "gemma3_4b":  "#06b6d4",
    "qwen25_3b":  "#6366f1",
}


def load_results():
    if not os.path.exists(RESULTS_FILE):
        print(
            f"ERROR: {RESULTS_FILE} not found. Run run_self_compression.py first.")
        sys.exit(1)
    with open(RESULTS_FILE, "r") as f:
        data = json.load(f)
    print(f"Loaded {len(data)} results")
    return data


def group_results(data):
    """Group results into {generator_slug: {compressor_name: [bpc_values]}}."""
    grouped = {}
    for r in data:
        slug = r["generator_slug"]
        comp = r["compressor_model"]
        grouped.setdefault(slug, {}).setdefault(comp, []).append(r["bpc"])
    return grouped


# ── Plot 1: BPC per compressor, grouped by generator ────────────────────────
def plot_bpc_by_compressor(data, grouped):
    """Grouped bar chart: each compressor has bars for each generator family."""
    slugs = sorted(grouped.keys())
    compressors = sorted(set(r["compressor_model"] for r in data))
    n_comp = len(compressors)
    n_gen = len(slugs)
    bar_w = 0.8 / max(n_gen, 1)
    x = np.arange(n_comp)

    fig, ax = plt.subplots(figsize=(14, 7))

    for gi, slug in enumerate(slugs):
        means = []
        stds = []
        for comp in compressors:
            vals = grouped.get(slug, {}).get(comp, [])
            means.append(np.mean(vals) if vals else 0)
            stds.append(np.std(vals) if vals else 0)

        color = GENERATOR_COLORS.get(slug, "#888888")
        label = GENERATOR_LABELS.get(slug, slug)
        bars = ax.bar(x + gi * bar_w, means, bar_w, yerr=stds,
                      label=f"Generated by {label}",
                      color=color, edgecolor="white", linewidth=0.4,
                      capsize=3, alpha=0.85)

        # Mark "self" bars
        self_name = SELF_MAP.get(slug)
        if self_name and self_name in compressors:
            idx = compressors.index(self_name)
            bars[idx].set_edgecolor("#FFD700")
            bars[idx].set_linewidth(3)
            bars[idx].set_hatch("//")

    ax.set_xticks(x + bar_w * (n_gen - 1) / 2)
    ax.set_xticklabels(compressors, fontsize=10, fontweight="bold")
    ax.set_ylabel("Bits Per Character (BPC)", fontsize=13, labelpad=10)
    ax.set_title("Self-Compression: BPC by Base Compressor Model",
                 fontsize=16, fontweight="bold", pad=18)
    ax.legend(loc="upper right", fontsize=9, framealpha=0.9)
    ax.yaxis.set_minor_locator(ticker.AutoMinorLocator())
    ax.grid(axis="y", alpha=0.25)

    # Add annotation for self-bars
    ax.annotate("★ = self-compression (gold border + hatching)",
                xy=(0.02, 0.97), xycoords="axes fraction",
                fontsize=9, color="#B8860B", va="top",
                bbox=dict(boxstyle="round,pad=0.3", facecolor="#FFFACD",
                          edgecolor="#B8860B", alpha=0.9))

    plt.tight_layout()
    out = os.path.join(OUTPUT_DIR, "self_compression_bpc_by_compressor.png")
    fig.savefig(out, dpi=200, bbox_inches="tight")
    print(f"Saved: {out}")
    plt.close(fig)
    return out


# ── Plot 2: Self vs Other average BPC ───────────────────────────────────────
def plot_self_vs_other(data, grouped):
    """Bar chart comparing self-compression BPC vs average other BPC."""
    slugs = sorted(grouped.keys())

    fig, ax = plt.subplots(figsize=(10, 6))

    x_pos = 0
    x_ticks = []
    x_labels = []

    for slug in slugs:
        self_name = SELF_MAP.get(slug)
        if not self_name:
            continue

        self_bpcs = grouped[slug].get(self_name, [])
        other_bpcs = []
        for comp, vals in grouped[slug].items():
            if comp != self_name:
                other_bpcs.extend(vals)

        if not self_bpcs:
            continue

        self_avg = np.mean(self_bpcs)
        other_avg = np.mean(other_bpcs) if other_bpcs else 0
        self_std = np.std(self_bpcs)
        other_std = np.std(other_bpcs) if other_bpcs else 0

        gen_label = GENERATOR_LABELS.get(slug, slug)
        gen_color = GENERATOR_COLORS.get(slug, "#888888")

        # Self bar
        ax.bar(x_pos, self_avg, 0.6, yerr=self_std, capsize=5,
               color=gen_color, edgecolor="#FFD700", linewidth=2.5,
               hatch="//", alpha=0.9, label=f"{gen_label} → Self" if x_pos == 0 else "")
        ax.text(x_pos, self_avg + self_std + 0.02, f"{self_avg:.3f}",
                ha="center", va="bottom", fontsize=10, fontweight="bold")
        x_ticks.append(x_pos)
        x_labels.append(f"{gen_label}\n(Self: {self_name})")

        # Other bar
        x_pos += 1
        ax.bar(x_pos, other_avg, 0.6, yerr=other_std, capsize=5,
               color="#cccccc", edgecolor="white", linewidth=0.5,
               alpha=0.7, label=f"{gen_label} → Other avg" if x_pos == 1 else "")
        ax.text(x_pos, other_avg + other_std + 0.02, f"{other_avg:.3f}",
                ha="center", va="bottom", fontsize=10, fontweight="bold")
        x_ticks.append(x_pos)
        x_labels.append(f"{gen_label}\n(Other models)")

        x_pos += 2  # gap between generators

    ax.set_xticks(x_ticks)
    ax.set_xticklabels(x_labels, fontsize=9)
    ax.set_ylabel("Average BPC", fontsize=13, labelpad=10)
    ax.set_title("Self-Compression vs Other Models",
                 fontsize=16, fontweight="bold", pad=18)
    ax.yaxis.set_minor_locator(ticker.AutoMinorLocator())
    ax.grid(axis="y", alpha=0.25)
    ax.legend(fontsize=9, framealpha=0.9)
    plt.tight_layout()

    out = os.path.join(OUTPUT_DIR, "self_compression_self_vs_other.png")
    fig.savefig(out, dpi=200, bbox_inches="tight")
    print(f"Saved: {out}")
    plt.close(fig)
    return out


# ── Plot 3: Heatmap – compressor × generated file ──────────────────────────
def plot_heatmap(data):
    """Heatmap of BPC: rows = compressor models, columns = generated files."""
    compressors = sorted(set(r["compressor_model"] for r in data))
    files = sorted(set(os.path.basename(r["source_file"]) for r in data))

    matrix = np.full((len(compressors), len(files)), np.nan)
    for r in data:
        ci = compressors.index(r["compressor_model"])
        fi = files.index(os.path.basename(r["source_file"]))
        matrix[ci, fi] = r["bpc"]

    fig, ax = plt.subplots(
        figsize=(max(14, len(files) * 1.2), max(6, len(compressors) * 0.8)))
    im = ax.imshow(matrix, aspect="auto", cmap="RdYlGn_r")
    fig.colorbar(im, ax=ax, shrink=0.7, label="BPC")

    ax.set_xticks(range(len(files)))
    ax.set_xticklabels([f.replace("generated_", "").replace(".py.txt", "").replace(".txt", "")
                        for f in files],
                       rotation=45, ha="right", fontsize=8)
    ax.set_yticks(range(len(compressors)))
    ax.set_yticklabels(compressors, fontsize=10)

    # Value annotations
    for ci in range(len(compressors)):
        for fi in range(len(files)):
            v = matrix[ci, fi]
            if not np.isnan(v):
                ax.text(fi, ci, f"{v:.2f}", ha="center", va="center", fontsize=7,
                        color="white" if v > np.nanmedian(matrix) else "black")

    ax.set_title("Self-Compression: BPC Heatmap (Compressor × Generated File)",
                 fontsize=15, fontweight="bold", pad=14)
    plt.tight_layout()

    out = os.path.join(OUTPUT_DIR, "self_compression_heatmap.png")
    fig.savefig(out, dpi=200, bbox_inches="tight")
    print(f"Saved: {out}")
    plt.close(fig)
    return out


# ── Plot 4: Model summary table ────────────────────────────────────────────
def plot_summary_table(data, grouped):
    """Styled PNG table: each compressor's avg BPC on each generator's code."""
    slugs = sorted(grouped.keys())
    compressors = sorted(set(r["compressor_model"] for r in data))

    col_labels = ["Compressor"]
    for slug in slugs:
        col_labels.append(f"Avg BPC\n({GENERATOR_LABELS.get(slug, slug)})")
    col_labels.append("Overall Avg")

    rows = []
    for comp in compressors:
        row = [comp]
        all_bpc = []
        for slug in slugs:
            vals = grouped.get(slug, {}).get(comp, [])
            avg = np.mean(vals) if vals else float("nan")
            row.append(f"{avg:.4f}" if vals else "—")
            all_bpc.extend(vals)
        overall = np.mean(all_bpc) if all_bpc else float("nan")
        row.append(f"{overall:.4f}" if all_bpc else "—")
        rows.append(row)

    # Sort by overall avg
    rows.sort(key=lambda r: float(r[-1]) if r[-1] != "—" else 999)

    fig, ax = plt.subplots(figsize=(10, 0.6 * len(rows) + 1.8))
    ax.axis("off")

    table = ax.table(cellText=rows, colLabels=col_labels,
                     cellLoc="center", loc="center")
    table.auto_set_font_size(False)
    table.set_fontsize(10)
    table.scale(1.0, 1.6)

    # Header style
    for j in range(len(col_labels)):
        cell = table[0, j]
        cell.set_facecolor("#4f46e5")
        cell.set_text_props(color="white", fontweight="bold")

    # Row styles
    for i in range(1, len(rows) + 1):
        color = "#f5f3ff" if i % 2 == 0 else "white"
        for j in range(len(col_labels)):
            table[i, j].set_facecolor(color)
            table[i, j].set_edgecolor("#e0e0e0")

        # Highlight self-compression cells
        comp_name = rows[i - 1][0]
        for gi, slug in enumerate(slugs):
            if SELF_MAP.get(slug) == comp_name:
                cell = table[i, gi + 1]
                cell.set_facecolor("#FFFACD")
                cell.set_text_props(fontweight="bold")

    # Highlight best (first row)
    for j in range(len(col_labels)):
        table[1, j].set_text_props(fontweight="bold")

    ax.set_title("Self-Compression Experiment – Model Summary (window=50)",
                 fontsize=14, fontweight="bold", pad=16)
    plt.tight_layout()

    out = os.path.join(OUTPUT_DIR, "self_compression_model_summary.png")
    fig.savefig(out, dpi=200, bbox_inches="tight", facecolor="white")
    print(f"Saved: {out}")
    plt.close(fig)
    return out


# ── Plot 5: Self-affinity table ─────────────────────────────────────────────
def plot_self_affinity_table(data, grouped):
    """Table showing self vs other BPC and the delta for each generator."""
    slugs = sorted(grouped.keys())

    col_labels = ["Generator", "Self Model", "Self BPC",
                  "Other Avg BPC", "Delta", "Self Wins?"]
    rows = []

    for slug in slugs:
        self_name = SELF_MAP.get(slug)
        if not self_name:
            continue

        gen_label = GENERATOR_LABELS.get(slug, slug)
        self_bpcs = grouped[slug].get(self_name, [])
        other_bpcs = []
        for comp, vals in grouped[slug].items():
            if comp != self_name:
                other_bpcs.extend(vals)

        if not self_bpcs:
            continue

        self_avg = np.mean(self_bpcs)
        other_avg = np.mean(other_bpcs) if other_bpcs else 0
        delta = self_avg - other_avg
        wins = "✓ Yes" if delta < 0 else "✗ No"

        rows.append([
            gen_label, self_name,
            f"{self_avg:.4f}", f"{other_avg:.4f}",
            f"{delta:+.4f}", wins,
        ])

    if not rows:
        return None

    fig, ax = plt.subplots(figsize=(12, 0.7 * len(rows) + 1.8))
    ax.axis("off")

    table = ax.table(cellText=rows, colLabels=col_labels,
                     cellLoc="center", loc="center")
    table.auto_set_font_size(False)
    table.set_fontsize(11)
    table.scale(1.0, 1.8)

    # Header
    for j in range(len(col_labels)):
        cell = table[0, j]
        cell.set_facecolor("#0e7490")
        cell.set_text_props(color="white", fontweight="bold")

    # Rows
    for i in range(1, len(rows) + 1):
        color = "#ecfeff" if i % 2 == 0 else "white"
        for j in range(len(col_labels)):
            table[i, j].set_facecolor(color)
            table[i, j].set_edgecolor("#e0e0e0")

        # Color the delta and wins columns
        delta_val = float(rows[i - 1][4])
        delta_cell = table[i, 4]
        wins_cell = table[i, 5]
        if delta_val < 0:
            delta_cell.set_text_props(color="#059669", fontweight="bold")
            wins_cell.set_text_props(color="#059669", fontweight="bold")
        else:
            delta_cell.set_text_props(color="#dc2626", fontweight="bold")
            wins_cell.set_text_props(color="#dc2626", fontweight="bold")

    ax.set_title("Self-Compression Affinity: Does a Base Model Compress Its Own Instruct Output Better?",
                 fontsize=13, fontweight="bold", pad=16)
    plt.tight_layout()

    out = os.path.join(OUTPUT_DIR, "self_compression_affinity.png")
    fig.savefig(out, dpi=200, bbox_inches="tight", facecolor="white")
    print(f"Saved: {out}")
    plt.close(fig)
    return out


# ── Plot 6: Per-file BPC comparison ────────────────────────────────────────
def plot_per_file_comparison(data, grouped):
    """For each generator, show BPC for each file across all compressors, bars colored by model."""
    slugs = sorted(grouped.keys())

    for slug in slugs:
        slug_data = [r for r in data if r["generator_slug"] == slug]
        if not slug_data:
            continue

        compressors = sorted(set(r["compressor_model"] for r in slug_data))
        files = sorted(set(os.path.basename(
            r["source_file"]) for r in slug_data))
        n_files = len(files)
        n_comp = len(compressors)
        bar_w = 0.85 / max(n_comp, 1)
        x = np.arange(n_files)

        fig, ax = plt.subplots(figsize=(max(12, n_files * 2), 7))

        self_name = SELF_MAP.get(slug)

        for ci, comp in enumerate(compressors):
            vals = []
            for fn in files:
                matches = [r["bpc"] for r in slug_data
                           if r["compressor_model"] == comp and
                           os.path.basename(r["source_file"]) == fn]
                vals.append(matches[0] if matches else 0)

            color = MODEL_COLORS.get(comp, "#888888")
            bars = ax.bar(x + ci * bar_w, vals, bar_w, label=comp,
                          color=color, edgecolor="white", linewidth=0.3)

            # Highlight self
            if comp == self_name:
                for b in bars:
                    b.set_edgecolor("#FFD700")
                    b.set_linewidth(2.5)
                    b.set_hatch("//")

        short_labels = [f.replace("generated_", "").replace(".py.txt", "").replace(".txt", "")
                        for f in files]
        ax.set_xticks(x + bar_w * (n_comp - 1) / 2)
        ax.set_xticklabels(short_labels, fontsize=9, rotation=30, ha="right")
        ax.set_ylabel("BPC", fontsize=13, labelpad=10)
        gen_label = GENERATOR_LABELS.get(slug, slug)
        ax.set_title(f"Per-File BPC – Code Generated by {gen_label} (window=50)",
                     fontsize=15, fontweight="bold", pad=18)
        ax.legend(loc="upper right", fontsize=8, framealpha=0.9, ncol=2)
        ax.yaxis.set_minor_locator(ticker.AutoMinorLocator())
        ax.grid(axis="y", alpha=0.25)
        plt.tight_layout()

        out = os.path.join(OUTPUT_DIR, f"self_compression_per_file_{slug}.png")
        fig.savefig(out, dpi=200, bbox_inches="tight")
        print(f"Saved: {out}")
        plt.close(fig)


# ── Main ─────────────────────────────────────────────────────────────────────
def main():
    os.makedirs(OUTPUT_DIR, exist_ok=True)
    data = load_results()
    grouped = group_results(data)

    generators = list(grouped.keys())
    compressors = sorted(set(r["compressor_model"] for r in data))
    print(f"\nGenerators: {generators}")
    print(f"Compressors: {compressors}")
    print()

    plot_bpc_by_compressor(data, grouped)
    plot_self_vs_other(data, grouped)
    plot_heatmap(data)
    plot_summary_table(data, grouped)
    plot_self_affinity_table(data, grouped)
    plot_per_file_comparison(data, grouped)

    # Print text summary
    print(f"\n{'─'*70}")
    print(f"{'Generator':<25} {'Self Model':<15} {'Self BPC':>10} {'Other Avg':>10} {'Delta':>10}")
    print(f"{'─'*70}")
    for slug in sorted(grouped.keys()):
        self_name = SELF_MAP.get(slug)
        if not self_name:
            continue
        gen_label = GENERATOR_LABELS.get(slug, slug)
        self_bpcs = grouped[slug].get(self_name, [])
        other_bpcs = []
        for comp, vals in grouped[slug].items():
            if comp != self_name:
                other_bpcs.extend(vals)
        if self_bpcs:
            self_avg = np.mean(self_bpcs)
            other_avg = np.mean(other_bpcs) if other_bpcs else 0
            delta = self_avg - other_avg
            print(
                f"{gen_label:<25} {self_name:<15} {self_avg:>10.4f} {other_avg:>10.4f} {delta:>+10.4f}")

    print(f"\nPlots saved to {OUTPUT_DIR}/self_compression_*.png")


if __name__ == "__main__":
    main()
